name: ci

on:
    pull_request:
        branches:
            - master

jobs:
    commitlint:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout ğŸ›
              uses: actions/checkout@v2
              with:
                  fetch-depth: 0
            - name: Run commitlinter ğŸ‘€
              uses: wagoid/commitlint-github-action@v3
    lint_and_tests:
        runs-on: ubuntu-latest
        services:
            redis:
                image: redis
                ports:
                    - '6379:6379'
                options: --entrypoint redis-server

            postgresl:
                container_name: temporal-postgresql
                environment:
                    POSTGRES_PASSWORD: temporal
                    POSTGRES_USER: temporal
                image: postgres:9.6
                ports:
                    - 5432:5432

            temporal:
                container_name: temporal
                depends_on:
                    - postgresql
                environment:
                    - DB=postgresql
                    - DB_PORT=5432
                    - POSTGRES_USER=temporal
                    - POSTGRES_PWD=temporal
                    - POSTGRES_SEEDS=postgresql
                image: temporalio/auto-setup:1.9.2
                ports:
                    - 7233:7233
        steps:
            - name: Checkout ğŸ›
              uses: actions/checkout@v2

            - name: Setup node env ğŸ—
              uses: actions/setup-node@v2.1.2
              with:
                  node-version: 16
                  check-latest: true

            - name: Setup Golang
              uses: actions/setup-go@v2
              with:
                go-version: '^1.16'

            - name: Cache node_modules ğŸ“¦
              uses: actions/cache@v2
              with:
                  path: ~/.npm
                  key: ubuntu-latest-node-${{ hashFiles('yarn.lock') }}
                  restore-keys: |
                      ubuntu-latest-node-
            - name: Install Node.js dependencies ğŸ‘¨ğŸ»â€ğŸ’»
              run: yarn --frozen-lockfile

            - name: Build TypeScript packages ğŸ‘·
              run: yarn run build:tsc

            - name: Run ESLint and Prettier ğŸ‘€
              run: yarn run lint

            - name: Run JavaScript tests ğŸ§ª
              run: yarn run test
              env:
                  REDIS_CONNECTION: 'local'
                  REDIS_HOST: '127.0.0.1'
                  REDIS_PORT: '6379'
                  GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
                  HOST: '0.0.0.0'
                  APP_KEY: '-qyExFFunSk4vSAvUiwheisaGicpYVpC'
